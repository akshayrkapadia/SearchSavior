document.addEventListener('DOMContentLoaded', function() {
  var searchbar = document.getElementById('searchbar');
  var answers = document.getElementById("answers");
  var searchButton = document.getElementById("searchButton");
  searchButton.addEventListener("click", function() {
    var q = searchbar.value;
    if ((q != null) && (q != 'undefined')) {
			chrome.storage.sync.set({
				"stored_q": q
			});
			answers.src = "https://akshayrkapadia.github.io/SearchSaviorCustomSearch/?q=" + q;
		}
  });
  searchbar.addEventListener("keyup", function(e) {
    if (e.keyCode == 13) {
      searchButton.click();
    }
  });
});

chrome.tabs.executeScript({
  code: "window.getSelection().toString();"
}, function(selection) {
  var searchbar = document.getElementById("searchbar");
  var q = "";
  if ((selection != null) && (selection[0] != "")) {
    q = selection[0];
    chrome.storage.sync.set({
      "stored_q": q
    });
    searchbar.value = q;
  	var searchButton = document.getElementById("searchButton");
    var answers = document.getElementById("answers");
    answers.src = "https://akshayrkapadia.github.io/SearchSaviorCustomSearch/?q=" + q;
    searchButton.click();
    searchbar.focus();
  } else {
    chrome.storage.sync.get("stored_q", function(result) {
      var searchbar = document.getElementById("searchbar");
      q = result.stored_q;
      if ((q != null) && (q != 'undefined')) {
      	searchbar.value = q;
  		}
  var searchButton = document.getElementById("searchButton");
      var answers = document.getElementById("answers");
      answers.src = "https://akshayrkapadia.github.io/SearchSaviorCustomSearch/?q=" + q;
      searchButton.click();
      searchbar.focus();
    });
  }
});
